##### iota_r - Indicator for whether infection with given TB strain can occur while on IPT by DR compartment#####
iota_r <- param_df%>%
filter(notation == 'iota')
iota_r <- iota_r$Reference_expected_value
##### zeta - Indicator that diminishes force of infection due to the partially-protective effect of LTBI infection and acquiring a new TB infection ######
zeta <- param_df%>%
filter(notation == 'zeta')
zeta <-zeta$Reference_expected_value
#### kappa_t_h_g_p - Rate of IPT initiation, per year ####
#currently averaged over gender, and only testing for policy 1
kappa_t_h_g <- array(data = 0, c(length(TB_SET), length(HIV_SET), length(G_SET)))
for (t in TB_SET){
for (h in HIV_SET){
for (g in G_SET){
temp <- param_df%>%
filter(P_compartment == 1,
notation == 'kappa',
TB_compartment == t,
HIV_compartment == h,
G_compartment == g)
if (nrow(temp) == 1){
kappa_t_h_g[t,h,g] <- temp$Reference_expected_value
}
}
}
}
####### varpi_g - IPT adherence #######
#currently averaged over gender, and only testing for policy 1
varpi_g <- param_df%>%
filter(P_compartment == 1, notation == 'varpi')%>%
arrange(G_compartment)
varpi_g <- varpi_g$Reference_expected_value
##### omega - Rate of moving off of IPT, per year ####
omega <-param_df%>%filter(notation == 'omega')
omega <- omega$Reference_expected_value
######### pi_i_t - Base rates of TB progression  #####
pi_i_t <- array(data = 0, c(length(TB_SET), length(TB_SET)))
for (t_from in TB_SET){
for (t_to in TB_SET){
num_temp = (t_from*10) + t_to
temp <- param_df%>%
filter(notation == 'pi',
TB_compartment == num_temp)
if (nrow(temp) == 1){
pi_i_t[t_from,t_to] <- temp$Reference_expected_value
}
}
}
#test impact of pi_i_t
pi_i_t[8,6] <- .02
#########theta_h - relative risk of TB progression###########
theta_h <-array(0, dim = length(HIV_SET))
#clean workspace
rm(list = ls())
gc()
#load packages
sapply(c('here', 'dplyr', 'reshape2', 'ggplot2', 'readxl'), require, character.only=T)
#Need to set project (upper R corner of screen) to epi_model_HIV_TB for here to work
indir <- paste0(here(),'/param_files/hiv_param_gen')
outdir <- paste0(here(),'/param_files')
setwd(indir)
calib_years<-1990:2017
genders <-c('Males', 'Females')
eta_23 <- 0.129533679
hiv_transmission_df<-read_excel('hiv_input_gen_data.xlsx', sheet = 'Sheet1')
hiv_transmission_df$year<-as.integer(hiv_transmission_df$year)
eta_34<-rep(0, times = nrow(hiv_transmission_df))
eta_24<-rep(0, times = nrow(hiv_transmission_df))
counter = 1
for (r in 1:nrow(hiv_transmission_df)){
#when ART only available to cd4 less
if ((hiv_transmission_df$year[counter] >= 2004)&(hiv_transmission_df$year[counter] <= 2010)){
n4_prop_next_yr <- hiv_transmission_df$art_coverage[counter+1]
n4_prop_current_yr <- hiv_transmission_df$art_coverage[counter]
n3_prop_current_yr <- hiv_transmission_df$`(HIV+ , not on ART and CD4 <200)`[counter]
eta_34[counter]<-(n4_prop_next_yr-n4_prop_current_yr)/n3_prop_current_yr
}
if ((hiv_transmission_df$year[counter] >= 2011)&(hiv_transmission_df$year[counter] <= 2015)) {
#need this
n4_prop_next_yr <- hiv_transmission_df$art_coverage[counter+1]
n4_prop_current_yr <- hiv_transmission_df$art_coverage[counter]
n3_prop_current_yr <- hiv_transmission_df$`(HIV+ , not on ART and CD4 <200)`[counter]
n2_prop_eligible_current_yr <-hiv_transmission_df$`(HIV+, not on ART and CD4 200-350)`
art_inititation<-(n4_prop_next_yr-n4_prop_current_yr)/(n3_prop_current_yr+n2_prop_eligible_current_yr)
eta_24[counter]<-art_inititation*hiv_transmission_df$n2_prop_eligible[counter]
eta_34[counter]<-art_inititation
}
if(hiv_transmission_df$year[counter]> 2015){
n4_prop_next_yr <- hiv_transmission_df$art_coverage[counter+1]
n4_prop_current_yr <- hiv_transmission_df$art_coverage[counter]
n3_prop_current_yr <- hiv_transmission_df$`(HIV+ , not on ART and CD4 <200)`[counter]
n2_prop_current_yr <-hiv_transmission_df$`(HIV+, not on ART and CD4 200-350)`+
hiv_transmission_df$`N (HIV+, not on ART and CD4 >350)`
art_inititation<-(n4_prop_next_yr-n4_prop_current_yr)/(n3_prop_current_yr+n2_prop_current_yr)
eta_24[counter]<-art_inititation
eta_34[counter]<-art_inititation
}
counter <- counter + 1
}
hiv_transmission_df$eta_24<-eta_24
hiv_transmission_df$eta_34<-eta_34
hiv_transmission_df<-hiv_transmission_df%>%
filter(year<=2017)
###create plots####
hiv_transition_rate_plot_df<-hiv_transmission_df%>%
select(c('year', 'gender', 'eta_24', 'eta_34'))%>%
melt(id.vars = c('year', 'gender'))%>%
mutate(transition_from = if_else(variable == 'eta_24',
'Transition from HIV+, CD4 >=200',
'Transition from HIV+, CD4 <200'),
transition_categories = paste0(gender,": ",transition_from))%>%
rename(initiation_rate = value)
#png('hiv_transitions_march_1.png', width=450,height=350,res=100)
print(ggplot(hiv_transition_rate_plot_df,
aes(x = year,
y = initiation_rate,
colour = transition_categories))+
geom_point() +
geom_line(aes(color = transition_categories)))
setwd(outdir)
write.csv(hiv_transmission_df, 'hiv_transmission_df.csv')
#clean workspace
rm(list = ls())
gc()
#load packages
sapply(c('dplyr', 'deSolve',
'readxl', 'stringr',
'reshape2', 'ggplot2', 'varhandle', 'here', 'readr'), require, character.only=T)
#set in directory and out directory
#Make sure you have the epi_model_HIV_TB.Rproj open, otherwise
#you will need to change the working directory manually.
indir <- paste0(here(),'/param_files')
outdir <- paste0(here(),'/model_outputs')
#read in data
setwd(indir)
param_df <- read_excel("Epi_model_parameters.xlsx", sheet = 'model_matched_parameters')
pop_init_df <- read_excel("Epi_model_parameters.xlsx", sheet = 'pop_init')
mort_df <- read.csv('mort_df.csv')
hiv_transition_df<-read.csv('hiv_transmission_df.csv')
#clean dataframe column names for consistency
names(param_df)<-str_replace_all(names(param_df), c(" " = "_" , "-" = "_" ))
names(pop_init_df)<-str_replace_all(names(pop_init_df), c(" " = "_" , "-" = "_" ))
#make sure all compartments are integer type for proper indexing#
param_df$TB_compartment<-as.integer(param_df$TB_compartment)
param_df$DR_compartment<-as.integer(param_df$DR_compartment)
param_df$HIV_compartment<-as.integer(param_df$HIV_compartment)
param_df$G_compartment<-as.integer(param_df$G_compartment)
param_df$P_compartment<-as.integer(param_df$P_compartment)
mort_df$TB_compartment<-as.integer(mort_df$TB_compartment)
mort_df$HIV_compartment<-as.integer(mort_df$HIV_compartment)
mort_df$G_compartment<-as.integer(mort_df$G_compartment)
mort_df$year<-as.integer(mort_df$year)
#establish compartment and dcompartment ids
pop_init_df<- pop_init_df%>%
mutate(compartment_id = paste0("N_", TB_compartment, "_", DR_compartment ,"_", HIV_compartment, "_", G_compartment),
dcompartment_id = paste0("dN_", TB_compartment, "_", DR_compartment ,"_", HIV_compartment, "_", G_compartment))
TB_SET<-1:8
HIV_SET<-1:4
DR_SET<-1:2
G_SET<-1:2
######### beta_g - Number of effective contacts for TB transmission per infectious year######
beta_g <- param_df%>%
filter(notation == 'beta')%>%
arrange(G_compartment)
beta_g <- beta_g$Reference_expected_value
###### phi_h - Relative transmissibility of TB in HIV pops#########
phi_h <- array(0, dim = length(HIV_SET))
for (h in HIV_SET){
temp <- param_df%>%
filter(notation == 'phi',
HIV_compartment == h)
phi_h[h] <- temp$Reference_expected_value
}
#### varepsilon_g - Fraction of new TB infections that are MDR-TB ####
varepsilon_g <- param_df%>%
filter(notation == 'varepsilon')%>%
arrange(G_compartment)
varepsilon_g <- varepsilon_g$Reference_expected_value
##### iota_r - Indicator for whether infection with given TB strain can occur while on IPT by DR compartment#####
iota_r <- param_df%>%
filter(notation == 'iota')
iota_r <- iota_r$Reference_expected_value
##### zeta - Indicator that diminishes force of infection due to the partially-protective effect of LTBI infection and acquiring a new TB infection ######
zeta <- param_df%>%
filter(notation == 'zeta')
zeta <-zeta$Reference_expected_value
#### kappa_t_h_g_p - Rate of IPT initiation, per year ####
#currently averaged over gender, and only testing for policy 1
kappa_t_h_g <- array(data = 0, c(length(TB_SET), length(HIV_SET), length(G_SET)))
for (t in TB_SET){
for (h in HIV_SET){
for (g in G_SET){
temp <- param_df%>%
filter(P_compartment == 1,
notation == 'kappa',
TB_compartment == t,
HIV_compartment == h,
G_compartment == g)
if (nrow(temp) == 1){
kappa_t_h_g[t,h,g] <- temp$Reference_expected_value
}
}
}
}
####### varpi_g - IPT adherence #######
#currently averaged over gender, and only testing for policy 1
varpi_g <- param_df%>%
filter(P_compartment == 1, notation == 'varpi')%>%
arrange(G_compartment)
varpi_g <- varpi_g$Reference_expected_value
##### omega - Rate of moving off of IPT, per year ####
omega <-param_df%>%filter(notation == 'omega')
omega <- omega$Reference_expected_value
######### pi_i_t - Base rates of TB progression  #####
pi_i_t <- array(data = 0, c(length(TB_SET), length(TB_SET)))
for (t_from in TB_SET){
for (t_to in TB_SET){
num_temp = (t_from*10) + t_to
temp <- param_df%>%
filter(notation == 'pi',
TB_compartment == num_temp)
if (nrow(temp) == 1){
pi_i_t[t_from,t_to] <- temp$Reference_expected_value
}
}
}
#test impact of pi_i_t
pi_i_t[8,6] <- .02
#########theta_h - relative risk of TB progression###########
theta_h <-array(0, dim = length(HIV_SET))
for (h in HIV_SET){
temp <- param_df%>%
filter(notation == 'theta',
HIV_compartment == h)
theta_h[h]<- temp$Reference_expected_value
}
###########gamma_r -indicator if DR compartment can move onto after IPT####
gamma_r <- c(1,0)
HIV_transitions_param_func<-function(yr){
eta_i_h_g <- array(0, dim=c(length(HIV_SET),
length(HIV_SET),
length(G_SET)))
for (g in G_SET){
#get HIV progression CD4 counts
temp <- param_df%>%
filter(notation == 'eta',
HIV_compartment == 23,
P_compartment == 1,
G_compartment == g)
eta_i_h_g[2,3,g]<-temp$Reference_expected_value
gender_name <-if_else(g == 1, 'Males', 'Females')
temp2<-hiv_transition_df%>%
filter(gender == gender_name,
year == yr)
eta_i_h_g[1,2,g]<-temp2$hiv_incidence
eta_i_h_g[2,4,g]<-temp2$eta_24
eta_i_h_g[3,4,g]<-temp2$eta_34
}
return(eta_i_h_g)
}
mort_param_func <-function(yr){
mu_t_h_g <- array(0, dim = c(length(TB_SET), length(HIV_SET), length(G_SET)))
for (t in TB_SET){
for (h in HIV_SET){
for (g in G_SET){
temp <- mort_df%>%
filter(year == yr,
TB_compartment == t,
HIV_compartment == h,
G_compartment == g)
mu_t_h_g[t,h,g] <- temp$mort_rate
}
}
}
return(mu_t_h_g)
}
########alpha_in_t_h_g - Proportion of population that enters each compartment#####
alpha_in_t_r_h_g <- array(data = 0, c(length(TB_SET), length(DR_SET), length(HIV_SET), length(G_SET)))
for (t in TB_SET){
for (r in DR_SET){
for (h in HIV_SET){
for (g in G_SET){
temp <- param_df%>%
filter(notation == 'alpha^in',
TB_compartment == t,
HIV_compartment == h,
DR_compartment == r,
G_compartment == g)
if (nrow(temp) == 1){
alpha_in_t_r_h_g[t,r,h,g] <- temp$Reference_expected_value
}
}
}
}
}
####### alpha_out - Rate of exit from the population ######
alpha_out <- param_df%>%filter(notation == 'alpha^out')
alpha_out <- alpha_out$Reference_expected_value
total_out_param_func<-function(mu_t_h_g){
total_out_t_r_h_g <- array(0, dim = length(TB_SET)*length(DR_SET)*length(HIV_SET)*length(G_SET))
count_temp <- 1
for (t in TB_SET){
for (r in DR_SET){
for (h in HIV_SET){
for (g in G_SET){
total_out_t_r_h_g[count_temp] <- (mu_t_h_g[t,h,g]*(1-alpha_out))+
((1-mu_t_h_g[t,h,g])*alpha_out)+
(mu_t_h_g[t,h,g]*alpha_out)
count_temp <- count_temp + 1
}
}
}
}
return(total_out_t_r_h_g)
}
#####N_init - total initial population in each compartment flattened in 1D array for ODE solver #####
#arrange pop init df, TB-->DR-->HIV-->G
pop_init_df<-pop_init_df%>%
arrange(G_compartment)%>%
arrange(HIV_compartment)%>%
arrange(DR_compartment)%>%
arrange(TB_compartment)
N_init <- pop_init_df$initialized_population_in_compartment
names(N_init) <- c(pop_init_df$compartment_id)
####N_t_r_h_g - matrix that identifies the location of compartment in 1D array#####
N_t_r_h_g_ref <- array(0, dim = c(length(TB_SET), length(DR_SET), length(HIV_SET), length(G_SET)))
count_temp <- 1
for (t in TB_SET){
for (r in DR_SET){
for (h in HIV_SET){
for (g in G_SET){
N_t_r_h_g_ref[t,r,h,g] <- count_temp
count_temp <- count_temp + 1
}
}
}
}
#where the equations are stored
open_seir_model <- function(time, N_t_r_h_g, parms){
dN_t_r_h_g <- array(0, dim = length(TB_SET)*length(DR_SET)*length(HIV_SET)*length(G_SET))
names(dN_t_r_h_g) <- pop_init_df$dcompartment_id
#calculate time varying parameters
#Force of Infection Calculations
FOI_1_g <- array(0, dim = length(G_SET))
FOI_2_g <- array(0, dim = length(G_SET))
for (g in G_SET){
FOI_1_g[g]<-(beta_g[g]*(sum((phi_h)*N_t_r_h_g[N_t_r_h_g_ref[6, 1, HIV_SET,g]])/sum(N_t_r_h_g)))
}
for (g in G_SET){
FOI_2_g[g] <-(varepsilon_g[g]*FOI_1_g[g])/(1-varepsilon_g[g])
}
FOI_r <- c(sum(FOI_1_g), sum(FOI_2_g))
FOI <- sum(FOI_r)
#write year parameter for parameters that change over time
current_yr <-as.integer(start_yr+time)
print(current_yr)
#HIV transitions
eta_i_h_g<-HIV_transitions_param_func(current_yr)
#deaths
mu_t_h_g<-mort_param_func(current_yr)
total_out_t_r_h_g<-total_out_param_func(mu_t_h_g)
#entries and exits from the population
B <- sum(total_out_t_r_h_g*N_t_r_h_g)
#######TB compartment 1 Equations #########
#Set DR compartment to 1, since not applicable to drug resistant compartments#
for (h in HIV_SET){
for (g in G_SET){
dN_t_r_h_g[N_t_r_h_g_ref[1,1,h,g]]<-(sum(alpha_in_t_r_h_g[1,1,h,g]*B) + #entries from births
(omega*N_t_r_h_g[N_t_r_h_g_ref[2,1,h,g]]) - #entries from off IPT
(total_out_t_r_h_g[N_t_r_h_g_ref[1,1,h,g]]*N_t_r_h_g[N_t_r_h_g_ref[1,1,h,g]]) - #exists from aging out and death
(FOI*N_t_r_h_g[N_t_r_h_g_ref[1,1,h,g]])- #exists from TB infection
(kappa_t_h_g[1,h,g]*N_t_r_h_g[N_t_r_h_g_ref[1,1,h,g]]) + #exists from on to IPT
(sum(eta_i_h_g[HIV_SET, h, g]*N_t_r_h_g[N_t_r_h_g_ref[1,1,HIV_SET,g]])) - #entries into HIV compartment
(sum(eta_i_h_g[h,HIV_SET, g])*N_t_r_h_g[N_t_r_h_g_ref[1,1,h,g]]) #exit from HIV compartment
)
}
}
#############TB compartment 2 Equations########
#Set DR compartment to 1, since not applicable to drug resistant compartments#
for (h in HIV_SET){
for (g in G_SET){
dN_t_r_h_g[N_t_r_h_g_ref[2,1,h,g]]<-((kappa_t_h_g[1,h,g]*N_t_r_h_g[N_t_r_h_g_ref[1,1,h,g]])- #entries from on to IPT
(total_out_t_r_h_g[N_t_r_h_g_ref[2,1,h,g]]*N_t_r_h_g[N_t_r_h_g_ref[2,1,h,g]])- #exists from aging out and death
(omega*N_t_r_h_g[N_t_r_h_g_ref[2,1,h,g]])- #exits from off IPT
((sum(iota_r*FOI_r))*N_t_r_h_g[N_t_r_h_g_ref[2,1,h,g]]) +#exits from infection (diminished for IPT)
(sum(eta_i_h_g[HIV_SET, h,g]*N_t_r_h_g[N_t_r_h_g_ref[2,1,HIV_SET,g]])) - #entries into HIV compartment
(sum(eta_i_h_g[h,HIV_SET,g])*N_t_r_h_g[N_t_r_h_g_ref[2,1,h,g]]) #exit from HIV compartment
)
}
}
#############TB compartment 3 Equations########
for (r in DR_SET){
for (h in HIV_SET){
for (g in G_SET){
dN_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]<-((alpha_in_t_r_h_g[3,r,h,g]*B) + #entries from births
(FOI_r[r]*N_t_r_h_g[N_t_r_h_g_ref[1,1,h,g]])+ #infection from compartment 1
(iota_r[r]*FOI_r[r]*N_t_r_h_g[N_t_r_h_g_ref[2,1,h,g]])+ #infections from compartment 2
(zeta*FOI_r[r]*sum(N_t_r_h_g[N_t_r_h_g_ref[4,DR_SET,h,g]]))+ #re-infection from compartment 4
(zeta*FOI_r[r]*sum(N_t_r_h_g[N_t_r_h_g_ref[7,DR_SET,h,g]]))+ #re-infection from compartment 7
(zeta*FOI_r[r]*sum(N_t_r_h_g[N_t_r_h_g_ref[8,DR_SET,h,g]]))- #re-infection from compartment 8
(total_out_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]*N_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]) - #exists from aging out and death
(pi_i_t[3,4]*N_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]) - #from recent to remote infection
(kappa_t_h_g[3,h,g]*N_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]) - #from recent to on IPT
((1/varpi_g[g])*theta_h[h]*pi_i_t[3,6]*N_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]) + #from recent TB infection to active
(sum(eta_i_h_g[HIV_SET,h,g]*N_t_r_h_g[N_t_r_h_g_ref[3,r,HIV_SET,g]])) - #entries into HIV compartment
(sum(eta_i_h_g[h,HIV_SET,g])*N_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]) #exit from HIV compartment
)
}
}
}
#############TB compartment 4 Equations########
for (r in DR_SET){
for (h in HIV_SET){
for (g in G_SET){
dN_t_r_h_g[N_t_r_h_g_ref[4,r,h,g]]<-((alpha_in_t_r_h_g[4,r,h,g]*B) + #entries from births
(pi_i_t[3,4]*N_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]) - #from recent to remote infection
(total_out_t_r_h_g[N_t_r_h_g_ref[4,r,h,g]]*N_t_r_h_g[N_t_r_h_g_ref[4,r,h,g]]) - #exists from aging out and death
(zeta*FOI*N_t_r_h_g[N_t_r_h_g_ref[4,r,h,g]])- #re-infection
(kappa_t_h_g[4,h,g]*N_t_r_h_g[N_t_r_h_g_ref[4,r,h,g]]) - #onto IPT
((1/varpi_g[g])*theta_h[h]*pi_i_t[4,6]*N_t_r_h_g[N_t_r_h_g_ref[4,r,h,g]]) + #from remote TB infection to active
(sum(eta_i_h_g[HIV_SET, h,g]*N_t_r_h_g[N_t_r_h_g_ref[4,r,HIV_SET,g]])) - #entries into HIV compartment
(sum(eta_i_h_g[h,HIV_SET,g])*N_t_r_h_g[N_t_r_h_g_ref[4,r,h,g]]) #exit from HIV compartment
)
}
}
}
#############TB compartment 5 Equations########
for (r in DR_SET){
for (h in HIV_SET){
for (g in G_SET){
dN_t_r_h_g[N_t_r_h_g_ref[5,r,h,g]] <-((kappa_t_h_g[3,h,g]*N_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]) + #from recent to on IPT
(kappa_t_h_g[4,h,g]*N_t_r_h_g[N_t_r_h_g_ref[4,r,h,g]]) - #onto IPT
(total_out_t_r_h_g[N_t_r_h_g_ref[5,r,h,g]]*N_t_r_h_g[N_t_r_h_g_ref[5,r,h,g]]) - #exists from aging out and death
((1/varpi_g[g])*theta_h[h]*pi_i_t[5,6]*N_t_r_h_g[N_t_r_h_g_ref[5,r,h,g]]) - #from TB infection on IPT to active
(gamma_r[r]*omega*N_t_r_h_g[N_t_r_h_g_ref[5,r,h,g]]) + #off IPT to after IPT
(sum(eta_i_h_g[HIV_SET, h,g]*N_t_r_h_g[N_t_r_h_g_ref[5,r,HIV_SET,g]])) - #entries into HIV compartment
(sum(eta_i_h_g[h,HIV_SET,g])*N_t_r_h_g[N_t_r_h_g_ref[5,r,h,g]]) #exit from HIV compartment
)
}
}
}
#############TB compartment 6 Equations########
for (r in DR_SET){
for (h in HIV_SET){
for (g in G_SET){
dN_t_r_h_g[N_t_r_h_g_ref[6,r,h,g]] <- ((alpha_in_t_r_h_g[6,r,h,g]*B) + #entries from births
((1/varpi_g[g])*theta_h[h]*pi_i_t[3,6]*N_t_r_h_g[N_t_r_h_g_ref[3,r,h,g]]) + #from recent TB infection to active
((1/varpi_g[g])*theta_h[h]*pi_i_t[4,6]*N_t_r_h_g[N_t_r_h_g_ref[4,r,h,g]]) + #from remote TB infection to active
((1/varpi_g[g])*theta_h[h]*pi_i_t[5,6]*N_t_r_h_g[N_t_r_h_g_ref[5,r,h,g]]) + #from TB infection on IPT to active
((1/varpi_g[g])*theta_h[h]*pi_i_t[8,6]*N_t_r_h_g[N_t_r_h_g_ref[8,r,h,g]]) - #from TB after on IPT to active
(total_out_t_r_h_g[N_t_r_h_g_ref[6,r,h,g]]*N_t_r_h_g[N_t_r_h_g_ref[6,r,h,g]]) - #total out
(pi_i_t[6,7]*N_t_r_h_g[N_t_r_h_g_ref[6,r,h,g]]) +#from active to recovered
(sum(eta_i_h_g[HIV_SET, h, g]*N_t_r_h_g[N_t_r_h_g_ref[6,r,HIV_SET,g]])) - #entries into HIV compartment
(sum(eta_i_h_g[h,HIV_SET,g])*N_t_r_h_g[N_t_r_h_g_ref[6,r,h,g]]) #exit from HIV compartment
)
}
}
}
#############TB compartment 7 Equations########
for (r in DR_SET){
for (h in HIV_SET){
for (g in G_SET){
dN_t_r_h_g[N_t_r_h_g_ref[7,r,h,g]] <- ((pi_i_t[6,7]*N_t_r_h_g[N_t_r_h_g_ref[6,r,h,g]]) - #from active to recovered
(total_out_t_r_h_g[N_t_r_h_g_ref[7,r,h,g]]*N_t_r_h_g[N_t_r_h_g_ref[7,r,h,g]]) - #total out
(zeta*FOI*N_t_r_h_g[N_t_r_h_g_ref[7,r,h,g]]) + #re-infection from compartment 7
(sum(eta_i_h_g[HIV_SET, h,g]*N_t_r_h_g[N_t_r_h_g_ref[7,r,HIV_SET,g]])) - #entries into HIV compartment
(sum(eta_i_h_g[h,HIV_SET,g])*N_t_r_h_g[N_t_r_h_g_ref[7,r,h,g]]) #exit from HIV compartment
)
}
}
}
#############TB compartment 8 Equations########
for (r in DR_SET){
for (h in HIV_SET){
for (g in G_SET){
dN_t_r_h_g[N_t_r_h_g_ref[8,r,h,g]] <- ((gamma_r[r]*omega*N_t_r_h_g[N_t_r_h_g_ref[5,r,h,g]]) - #off IPT to after IPT
((1/varpi_g[g])*theta_h[h]*pi_i_t[8,6]*N_t_r_h_g[N_t_r_h_g_ref[8,r,h,g]]) - #from TB after on IPT to active
(total_out_t_r_h_g[N_t_r_h_g_ref[8,r,h,g]]*N_t_r_h_g[N_t_r_h_g_ref[8,r,h,g]]) - #total out
(zeta*FOI*N_t_r_h_g[N_t_r_h_g_ref[8,r,h,g]])+
(sum(eta_i_h_g[HIV_SET, h,g]*N_t_r_h_g[N_t_r_h_g_ref[8,r,HIV_SET,g]])) - #entries into HIV compartment
(sum(eta_i_h_g[h,HIV_SET,g])*N_t_r_h_g[N_t_r_h_g_ref[8,r,h,g]]) #exit from HIV compartment
)
}
}
}
list(dN_t_r_h_g)
}
#Time Horizon and Evaluation intervals (1 month)
start_yr = 1990
end_yr = 2017
TT<-end_yr-start_yr
time_interval <- 1/12
TT_SET <- seq(from = 0, to = TT, by = time_interval)
out_df_all<-data.frame()
sim_id <-1
beta_1_test<-c(.005)
beta_2_test<-c(.005)
for (beta_1 in beta_1_test){
for (beta_2 in beta_2_test){
beta_g[1]<-beta_1
beta_g[2]<-beta_2
out_df<-as.data.frame(ode(times = TT_SET, y = N_init,
func = open_seir_model, method = 'lsoda',
parms = NULL))
out_df<- cbind(year = as.integer(start_yr+out_df$time), sim_id = rep(sim_id, times = nrow(out_df)),
beta_1 = rep(beta_1, times = nrow(out_df)), beta_2 = rep(beta_2, times = nrow(out_df)),
out_df)
out_df_all<-rbind(out_df_all, out_df)
sim_id <- sim_id + 1
print(sim_id)
}
}
